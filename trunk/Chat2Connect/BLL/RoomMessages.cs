
// Generated by MyGeneration Version # (1.3.0.3)

using System;
using System.Collections.Specialized;
using System.Data;
using System.Data.SqlClient;
using DAL;
using System.Collections.Generic;
using System.Linq;

namespace BLL
{
    public class RoomMessages : _RoomMessages
    {
        public RoomMessages()
        {

        }

        public override void AddNew()
        {
            base.AddNew();
            MessageDate = DateTime.Now;
        }

        public List<Helper.ChatMessage> GetLatestMessags(int rid, int startID)
        {
            string sql = @"SELECT TOP 50 RoomMessages.*,[MemberName]=M.Name
                            FROM RoomMessages
                            INNER JOIN Member M on RoomMessages.MemberID=M.MemberID
                            WHERE RoomID={0} AND ({1}=0 OR ID<{1})
                            ORDER BY MessageDate DESC";
            LoadFromRawSql(sql, rid, startID);
            return GetJson();
        }
        public List<Helper.ChatMessage> GetJson()
        {
            var result = DefaultView.Table.AsEnumerable().Select(m => new Helper.ChatMessage()
            {
                ID = m[ColumnNames.ID],
                FromID = m[ColumnNames.MemberID],
                ToID = m[ColumnNames.RoomID],
                FromName = m["MemberName"],
                Message = m[ColumnNames.Message],
                MessageDate = m[ColumnNames.MessageDate],
                MemberLevel = m[ColumnNames.MemberLevel]
            });
            return result.OrderBy(m=>m.MessageDate).ToList();
        }

    }
}
